name: Sync GCG Content to Server Branch

on:
  push:
    branches: [ master ]
    paths:
      - 'ocgcore/**'
      - 'script/**'
      - 'gframe/**'
      - 'cards.cdb'
      - 'lflist.conf'
      - 'strings.conf'
      - 'system.conf'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-to-server:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Sync GCG content to server branch
      run: |
        set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º

        echo "ğŸš€ å¼€å§‹åŒæ­¥GCGå†…å®¹åˆ°serveråˆ†æ”¯..."

        # é…ç½®Git
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # è¦åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨
        FILES_TO_SYNC=("gframe" "ocgcore" "script" "cards.cdb" "lflist.conf" "strings.conf" "system.conf")

        # åˆ‡æ¢åˆ°serveråˆ†æ”¯
        echo "ğŸ”„ åˆ‡æ¢åˆ°serveråˆ†æ”¯..."
        if git show-ref --verify --quiet refs/heads/server; then
          echo "âœ… æœ¬åœ°serveråˆ†æ”¯å·²å­˜åœ¨"
          git checkout server
          git pull origin server || echo "âš ï¸  æ— æ³•pullï¼Œä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬"
        else
          echo "ğŸ”„ æ£€å‡ºè¿œç¨‹serveråˆ†æ”¯..."
          git checkout -b server origin/server
        fi

        # åˆ›å»ºä¸´æ—¶åˆ†æ”¯è¿›è¡ŒåŒæ­¥
        TEMP_BRANCH="temp-sync-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$TEMP_BRANCH"

        echo "ğŸ“‹ åŒæ­¥ä»¥ä¸‹æ–‡ä»¶å’Œç›®å½•:"
        SYNCED_FILES=()
        FAILED_FILES=()

        # ä»masteråˆ†æ”¯å¤åˆ¶æ–‡ä»¶
        for file in "${FILES_TO_SYNC[@]}"; do
          echo "ğŸ”„ åŒæ­¥: $file"
          if git checkout master -- "$file" 2>/dev/null; then
            SYNCED_FILES+=("$file")
            echo "  âœ… $file"
          else
            FAILED_FILES+=("$file")
            echo "  âŒ $file (æ–‡ä»¶ä¸å­˜åœ¨)"
          fi
        done

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --cached --quiet && git diff --quiet; then
          echo "â„¹ï¸  æ²¡æœ‰æ–‡ä»¶éœ€è¦åŒæ­¥"
          git checkout server
          git branch -D "$TEMP_BRANCH"
          echo "âœ… åŒæ­¥å®Œæˆ (æ— å˜æ›´)"
          exit 0
        fi

        # æäº¤å˜æ›´
        echo "ğŸ’¾ æäº¤å˜æ›´..."
        git add -A

        # è·å–masteråˆ†æ”¯ä¿¡æ¯
        MASTER_COMMIT=$(git rev-parse master)
        MASTER_MSG=$(git log -1 --pretty=%B master | head -n1)

        # ç”Ÿæˆæäº¤ä¿¡æ¯
        COMMIT_MESSAGE="Sync GCG content from master

        Synced files:"
        for file in "${SYNCED_FILES[@]}"; do
          COMMIT_MESSAGE="$COMMIT_MESSAGE
        - $file"
        done

        if [ ${#FAILED_FILES[@]} -gt 0 ]; then
          COMMIT_MESSAGE="$COMMIT_MESSAGE

        Failed files:"
          for file in "${FAILED_FILES[@]}"; do
            COMMIT_MESSAGE="$COMMIT_MESSAGE
        - $file (not found)"
          done
        fi

        COMMIT_MESSAGE="$COMMIT_MESSAGE

        Source commit: ${MASTER_COMMIT}
        Source message: ${MASTER_MSG}

        ğŸ¤– Auto-sync by GitHub Actions
        Co-Authored-By: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

        git commit -m "$COMMIT_MESSAGE"

        # åˆå¹¶åˆ°serveråˆ†æ”¯
        echo "ğŸ”€ åˆå¹¶åˆ°serveråˆ†æ”¯..."
        git checkout server
        git merge "$TEMP_BRANCH" --no-ff -m "Merge GCG content sync from master"

        # æ¨é€serveråˆ†æ”¯
        echo "ğŸ“¤ æ¨é€åˆ°è¿œç¨‹serveråˆ†æ”¯..."
        git push origin server

        # æ¸…ç†ä¸´æ—¶åˆ†æ”¯
        git branch -d "$TEMP_BRANCH"

        # è¾“å‡ºåŒæ­¥æ‘˜è¦
        echo ""
        echo "âœ… åŒæ­¥å®Œæˆ!"
        echo "ğŸ“Š åŒæ­¥æ‘˜è¦:"
        echo "  - æºåˆ†æ”¯: master"
        echo "  - ç›®æ ‡åˆ†æ”¯: server"
        echo "  - æˆåŠŸåŒæ­¥: ${#SYNCED_FILES[@]} ä¸ªæ–‡ä»¶/ç›®å½•"
        echo "  - å¤±è´¥: ${#FAILED_FILES[@]} ä¸ªæ–‡ä»¶/ç›®å½•"
        echo ""

        if [ ${#SYNCED_FILES[@]} -gt 0 ]; then
          echo "âœ… æˆåŠŸåŒæ­¥çš„æ–‡ä»¶:"
          for file in "${SYNCED_FILES[@]}"; do
            echo "  - $file"
          done
        fi

        if [ ${#FAILED_FILES[@]} -gt 0 ]; then
          echo "âŒ æœªæ‰¾åˆ°çš„æ–‡ä»¶:"
          for file in "${FAILED_FILES[@]}"; do
            echo "  - $file"
          done
        fi

        echo ""
        echo "ğŸš€ serveråˆ†æ”¯å·²æ›´æ–°å¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“"